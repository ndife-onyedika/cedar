{% extends 'dashboard/base_layout.html' %}
{% load static %}

{% load notifications_tags %}

{% block title %} {{ dashboard.title }} | Dashboard | Marafa Cedar {% endblock  %}

{% block mini_head %}
<link rel="stylesheet" href="{% static 'vendor/css/daterangepicker.css' %}">
{% endblock mini_head %}

{% block mini_content %}
<div class="h-100">
    <div class="row g-0">
        {% include 'dashboard/util/routes/sidebar.html' %}

        <main class="col-md-9 ms-sm-auto col-lg-10 bg-light">
            {% include 'dashboard/util/routes/nav.html' %}
            {% block mini-dash_content %}{% endblock  %}
        </main>
    </div>
</div>

<div class="screen_loader-box none">
    <span class="screen_loader"></span>
</div>
{% include 'dashboard/util/modals/index.html' %}
{% include 'dashboard/util/offcanvas/index.html' %}
{% endblock %}

{% block script %}
<script src="{% static 'vendor/js/daterangepicker.js' %}"></script>
<script>
    var loan_id = "{{loan_id}}";
    loan_id = loan_id !== "" ? loan_id : null;

    var member_id = "{{member.id}}";
    member_id = member_id !== "" ? member_id : null;
    const isStaff = "{{request.user.is_staff}}".toLowerCase() == "true"


    const table_tabs = {
        members: [
            ["all", "All"],
            ["true", "Active"],
            ["false", "Inactive"]
        ],
        savings: [
            ["all", "All"],
            ["credit", "Credit"],
            ["debit", "Debit"]
        ],
        loans: [
            ["disbursed", "Disbursed"],
            ["terminated", "Terminated"]
        ],
        savings_interest: [
            ["total", "Total Interests"],
            ["all", "Interests"],
            ["each", "Savings Interests"],
        ],

    }

    const table_heads = {
        eoy: ["Dated Created"],
        shares: ["Dated Created", ""],
        "loans.repayment": ["Date Paid", ""],
        savings: {
            all: ["Reason", "Date Created", ""],
            credit: ["Reason", "Date Created", ""],
            debit: ["Reason", "Date Created", ""]
        },
        savings_interest: {
            total: ["Total Interest", "Date Range"],
            all: ["Interest", "Total Interest", "Date Created"],
            each: ["Interest", "Date Created", "Date Updated"],
        },
        loans: {
            disbursed: ["Outstanding Amount", "Rate", "Duration", "Guarantors",
                "Date Created", "Date Updated", ""
            ],
            terminated: ["Rate", "Duration", "Guarantors", "Date Created",
                "Date Terminated", ""
            ]
        },
        members: {
            all: ["Name", "Balance", "Status", "Account Type", "Account Number", "Date Registered", ""],
            true: ["Name", "Balance", "Status", "Account Type", "Account Number", "Date Registered", ""],
            false: ["Name", "Balance", "Status", "Account Type", "Account Number", "Date Registered", ""]
        },
    }

    const table_filters = {
        members: [{
                type: "text",
                label: "Search",
                name: "search_text",
            },
            {
                type: "date",
                name: "search_date",
                label: "Search by Date"
            },
            {
                type: "text",
                name: "account_number",
                label: "Account Number"
            },
            {
                type: "select",
                name: "account_type",
                label: "Account Type",
                options: [
                    [null, "Select..."],
                    ["normal", "Normal"],
                    ["staff", "Staff"]
                ],
            }
        ],
        shares: [{
                type: "text",
                label: "Search",
                name: "search_text",
            },
            {
                type: "date",
                name: "search_date",
                label: "Search by Date"
            },
            {
                type: "date",
                name: "updated_at",
                label: "Search by Date Updated"
            },

        ],
        savings: [{
                type: "text",
                label: "Search",
                name: "search_text",
            },
            {
                type: "date",
                name: "search_date",
                label: "Search by Date"
            },
            {
                type: "select",
                name: "reason",
                label: "Reason",
                options: [
                    [null, "Select..."],
                    ["credit-deposit", "Deposit"],
                    ["debit-withdrawal", "Withdrawal"],
                    ["credit-eoy", "End of Year Balance"],
                ],
            },
        ],
        eoy: [{
                type: "text",
                label: "Search",
                name: "search_text",
            },
            {
                type: "date",
                name: "search_date",
                label: "Search by Date"
            }
        ],
        savings_interest: [{
                type: "text",
                label: "Search",
                name: "search_text",
            },
            {
                type: "date",
                name: "search_date",
                label: "Search by Date"
            }
        ],
        loans: [{
                type: "text",
                label: "Search",
                name: "search_text",
            },
            {
                type: "date",
                name: "search_date",
                label: "Search by Date"
            }
        ],
        "loans.repayment": [{
            type: "text",
            label: "Search",
            name: "search_text",
        }, {
            type: "date",
            name: "search_date",
            label: "Search by Date"
        }]
    }

    const setTable = () => $("[data-table-name]").each(function () {
        let table = $(this);
        let table_name = table.attr("data-table-name");
        let hasQueryParam = window.location.search !== "";
        let table_attr = JSON.parse(table.attr("data-table-attr"));
        table_attr = {
            ...table_attr,
            ...(["loans", "members", "savings", "savings_interest"].includes(table_name) ? {
                table_context: table_tabs[table_name][0][0]
            } : {})
        }


        tabulate(table_name, table_attr);
        if (hasQueryParam) {
            let query = window.location.search.slice(1)
            let query1 = query.split("&");
            let query2 = query1.map(item => item.split("="));
            query2 = Object.fromEntries(query2)
            table_attr.table_context = query2.tab;

            if (table_name == "savings_interest") {
                if (query2.tab == "total") $("#tid").removeClass("d-none");
                else $("#tid").addClass("d-none");
            }

            const url = new URL(window.location);
            for (let i = 0; i < table_filters[table_name].length; i++) {
                const item = table_filters[table_name][i];
                if (url.searchParams.has(item.name)) table_attr[item.name] = url.searchParams.get(item.name);
            }

            setTimeout(() => {
                tabulate(table_name, table_attr);
            }, 1000)
        }
    });

    const resetDate = () => $(`input.date`).each(function () {
        let date = $(this);
        let value = date.val();
        if (value !== "") {
            let timestamp = moment(value, 'YYYY-MM-DD');
            timestamp = timestamp.format('DD MMM, YYYY')
            date.data("daterangepicker").setStartDate(timestamp);
            date.data("daterangepicker").setEndDate(timestamp);
            date.val(timestamp);
        }
    });

    const resetDateTime = () => $(`input.datetime`).each(function () {
        let datetime = $(this);
        let value = datetime.val();
        if (value !== "") {
            let timestamp = moment(value, 'YYYY-MM-DD hh:mm:ss');
            timestamp = timestamp.format('MMM DD, YYYY, h:mm a')
            datetime.data("daterangepicker").setStartDate(timestamp);
            datetime.data("daterangepicker").setEndDate(timestamp);
            datetime.val(timestamp);
        }
    });

    const resetDateRange = () => $('input.daterange').each(function () {
        let daterange = $(this);
        let value = daterange.val();
        if (value !== "") {
            value = value.split(" - ");
            let start_date = moment(value[0], 'Do MMM YYYY');
            let end_date = moment(value[1], 'Do MMM YYYY');
            daterange.data("daterangepicker").setStartDate(start_date);
            daterange.data("daterangepicker").setEndDate(end_date);
            daterange.val(value.join(" - "));
        }
    });

    const clearForm = container => {
        if (container.find("form").length) {
            container.find("form")[0].reset();
            container.find("form").attr("data-context", "create");
            $(".is-invalid").removeClass("is-invalid");
            $(".invalid-feedback").removeClass("d-block");
            $(".invalid-feedback").html();
        };
        if (container.find(".carousel").length) {
            let carouselEl = container.find(".carousel");
            const carousel = bootstrap.Carousel.getOrCreateInstance(carouselEl);
            carousel.to(0);
        }
        if (container.find('input.datetime').length) {
            container.find('input.datetime').data('daterangepicker').setStartDate(moment());
            container.find('input.datetime').data('daterangepicker').setEndDate(moment());
        }
        create_custom_dropdowns();
    };

    const setCalenders = () => {
        $('input.daterange').daterangepicker({
            "drops": "auto",
            "opens": "left",
            "autoApply": false,
            "showDropdowns": true,
            "autoUpdateInput": false,
            "linkedCalendars": false,
            "alwaysShowCalendars": true,
            "locale": {
                "cancelLabel": 'Clear',
                "format": 'Do MMM YYYY'

            }
        }, function (start, end, label) {
            this.element.val(
                `${start.format('Do MMM YYYY')} - ${ end.format('Do MMM YYYY')}`);
        }).prop("readonly", true);

        $('input.daterange').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });
        resetDateRange();
    }

    $(".offcanvas").on("hide.bs.offcanvas", function () {
        clearForm($(this))
    })
    $(".modal").on("hidden.bs.modal", function () {
        clearForm($(this))
    })




    $(document).ready(function () {
        setTable();
        $(`input.date`).daterangepicker({
            "drops": "auto",
            "opens": "left",
            "showDropdowns": true,
            "autoUpdateInput": false,
            "singleDatePicker": true,
            "alwaysShowCalendars": true,
            "locale": {
                "cancelLabel": 'Clear',
                "format": 'MMM DD, YYYY'
            }
        }, function (start, end, label) {
            this.element.val(start.format('MMM DD, YYYY'));
        }).prop("readonly", true);

        $(`input.datetime`).daterangepicker({
            "drops": "auto",
            "opens": "left",
            "timePicker": false,
            "showDropdowns": true,
            "autoUpdateInput": true,
            "singleDatePicker": true,
            "alwaysShowCalendars": true,
            "locale": {
                "cancelLabel": 'Clear',
                "format": 'MMM DD, YYYY'
            }
        }, function (start, end, label) {
            this.element.val(start.format('MMM DD, YYYY'));
        }).prop("readonly", true);

        $('input.date, input.daterange, input.datetime').on('cancel.daterangepicker', function (ev, picker) {
            $(this).val('');
        });
        $('#sidebarMenu .nav-item').each(function () {
            let context = "{{ dashboard.context }}";
            if ($(this).attr("data-context") == context) {
                $(this).children().addClass("active");
                $(this).children().attr("aria-current", "page");
            }
        });
    });

    const tabulate = (table_name, table_attr) => {
        const {
            selected_id,
            ...new_table_attr
        } = table_attr;
        populateTable({
            ...new_table_attr,
            table_name,
            ...(member_id ? {
                member_id
            } : {}),
            ...(loan_id ? {
                loan_id
            } : {})
        });
        let table_attr_stringify = JSON.stringify(new_table_attr);
        $(`[data-table-name='${table_name}']`).attr("data-table-attr", table_attr_stringify);
    }

    function populateTable({
        page,
        sort_by,
        per_page,
        table_name,
        ...kwargs
    }) {
        let table_context = kwargs.table_context;
        let table_tab = table_tabs[table_name];
        let table_head = !table_context ?
            table_heads[table_name] : table_heads[table_name][table_context];

        let hasTabs = ["loans", "members", "savings", "savings_interest"].includes(table_name);

        table_head = [
            "#",
            ...(!["members", "loans.repayment"].includes(table_name) && !member_id ? ["Member"] : []),
            ...(!["members", "savings_interest"].includes(table_name) ||
                table_name == "savings_interest" && table_context != "total" ? ["Amount"] : []),
            ...(!$(`[data-table-name='${table_name}'] .table`).hasClass("home") ?
                table_head : table_head.slice(0, -1)),
        ]

        $(`[data-table-name='${table_name}'] .table thead`).html(
            `<tr>
                ${!$(`[data-table-name='${table_name}'] .table`).hasClass("home")
                    ? `<th scope="col"><input class="form-check-input p-0 tableChkMaster" type="checkbox" aria-label="..."></th>`
                    : ""
                }
                ${table_head.map(title => `<th scope="col">${title}</th>`)}
            </tr>`
        );

        $.ajax({
            dataType: 'json',
            url: "{% url 'ajax:dt' %}",
            data: {
                page: page,
                per_page: per_page,
                table_name: table_name,
                ...kwargs
            },
            success: data => {
                if (data.content.length > 0) {
                    let table_rows = ``;
                    for (let i = 0; i < data.content.length; i++) {
                        let item = data.content[i];
                        table_rows += `
                            <tr class="align-middle">
                                ${!$(`[data-table-name='${table_name}'] .table`).hasClass("home") ? 
                                    `<td><input id="tableChk${i}" class="form-check-input" type="checkbox" value="${item.id}" aria-label="..."></td>`
                                    : ""
                                }
                                <th scope="row">${i+1}</th>
                                
                                ${table_name == "members" 
                                    ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.id}">${item.name}</a>
                                        </td>
                                        <td>${item.balance}</td>
                                        <td>
                                            <span 
                                                class="p-1 px-2 small bg-opacity-25 rounded-pill text-${item.is_active ? "primary" : "danger"} bg-${item.is_active ? "primary" : "danger"}">
                                                ${item.is_active?"active":"inactive"}
                                            </span>
                                        </td>
                                        <td>${item.account_type}</td>
                                        <td>${item.account_number}</td>
                                        <td>${to_local_date(item.created_at)}</td>
                                        <td>
                                            <button 
                                                type="button"
                                                data-value='{"id":"${item.id}","url":"/ajax/sd/members","button":"Delete","title":"Are you sure?","detail":"You are about to permanently delete the record <strong>${item.name}</strong>. All associating contents will be deleted and will no longer be accessible."}'
                                                class="prompt_modal btn btn-link text-danger fw-semibold text-decoration-none">
                                                    Delete
                                                </button>
                                        </td>` 
                                    : ''
                                }
                                ${table_name == "shares" 
                                    ? `${!member_id ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.mid}/?tab=shares">${item.name}</a>
                                        </td>`:""}
                                        <td>${item.amount}</td>
                                        <td>${to_local_datetime(item.created_at)}</td>
                                        <td>
                                            <button 
                                                type="button"
                                                data-value='{"target":"#sc","url":"/ajax/sf/shares/${item.id}"}'
                                                class="edit_canvas btn btn-link text-primary fw-semibold text-decoration-none">
                                                Edit
                                            </button>
                                            <button 
                                                type="button"
                                                data-value='{"id":"${item.id}","url":"/ajax/sd/shares","button":"Delete","title":"Are you sure?","detail":"You are about to permanently delete ${!member_id?`the sahres record for <strong>${item.name}</strong>`:"this shares record"}. All associating contents will be deleted and will no longer be accessible."}'
                                                class="prompt_modal btn btn-link text-danger fw-semibold text-decoration-none">
                                                    Delete
                                            </button>
                                        </td>` 
                                    : ''
                                }
                                ${table_name == "savings" 
                                    ? `${!member_id ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.mid}/?tab=savings">${item.name}</a>
                                        </td>`:""}
                                        <td>
                                            <span class="${item.amount.startsWith("+")?"text-primary":"text-danger"}">
                                                ${item.amount.startsWith("+")?item.amount.slice(1):item.amount}
                                            </span>
                                        </td>
                                        <td>${item.reason}</td>
                                        <td>${to_local_datetime(item.created_at)}</td>
                                        ${!$(`[data-table-name='${table_name}'] .table`).hasClass("home") ?
                                            `<td>
                                                <button 
                                                    type="button"
                                                    class="edit_canvas btn btn-link text-primary fw-semibold text-decoration-none"
                                                    data-value='{"target":"#${item.amount.startsWith("+")?"sdc":"swc"}","url":"/ajax/sf/savings.${item.amount.startsWith("+")?"credit":"debit"}/${item.id}"}'>
                                                        Edit
                                                </button>
                                                <button 
                                                    type="button"
                                                    class="prompt_modal btn btn-link text-danger fw-semibold text-decoration-none"
                                                    data-value='{"id":"${item.id}","url":"/ajax/sd/savings.${item.amount.startsWith("+")?"credit":"debit"}","button":"Delete","title":"Are you sure?","detail":"You are about to permanently delete ${!member_id?`the savings record for <strong>${item.name}</strong>`:"this savings record"}. All associating contents will be deleted and will no longer be accessible."}'>
                                                        Delete
                                                </button>
                                            </td>`
                                            : ""
                                        }` 
                                    : ''
                                }
                                ${table_name == "eoy" 
                                    ? `${!member_id ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.mid}/?tab=eoy">${item.name}</a>
                                        </td>`:""}
                                        <td>${item.amount}</td>
                                        <td>${to_local_datetime(item.created_at)}</td>`
                                    : ''
                                }
                                ${table_name == "loans" 
                                    ? `${!member_id ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.mid}/?tab=loans&sub_tab=${table_context}">${item.name}</a>
                                        </td>`:""}
                                        <td>${item.amount}</td>
                                        ${table_context == "disbursed"
                                            ? `<td>${item.outstanding_amount}</td>`
                                            : ""
                                        }
                                        <td>${item.rate}</td>
                                        <td>${item.duration}</td>
                                        <td class="py-0">
                                            ${item.guarantors.length > 0 
                                                ? item.guarantors.map(guar=>`<a href="{% url 'dashboard:home' %}members/${guar.mid}">${guar.name}</a>`).join(", ")
                                                : "N/A"
                                            }
                                        </td>
                                        <td>${to_local_datetime(item.created_at)}</td>
                                        <td>${to_local_datetime(item.updated_at)}</td>
                                        <td class="d-flex flex-column align-items-start">
                                            <a 
                                                href="{% url 'dashboard:loans' %}${item.id}/"
                                                class="btn btn-link text-info fw-semibold text-decoration-none">
                                                    View
                                            </a>
                                            <button 
                                                type="button"
                                                data-value='{"target":"#lc","url":"/ajax/sf/loans/${item.id}"}'
                                                class="edit_canvas btn btn-link text-primary fw-semibold text-decoration-none">
                                                Edit
                                            </button>
                                            <button 
                                                type="button"
                                                data-value='{"id":"${item.id}","url":"/ajax/sd/loans","button":"Delete","title":"Are you sure?","detail":"You are about to permanently delete ${!member_id?`the loan record for <strong>${item.name}</strong>`:"this loan record"}. All associating contents will be deleted and will no longer be accessible."}'
                                                class="prompt_modal btn btn-link text-danger fw-semibold text-decoration-none">
                                                    Delete
                                            </button>
                                        </td>`
                                    : ''
                                }
                                ${table_name == "loans.repayment" 
                                    ? `${!["members", "loans.repayment"].includes(table_name) && !member_id ? `<td>
                                            <a href="{% url 'dashboard:loans' %}${item.id}">${item.name}</a>
                                        </td>`:""}
                                        <td>${item.amount}</td>
                                        <td>${to_local_datetime(item.created_at)}</td>
                                        <td>
                                            <button 
                                                type="button"
                                                data-value='{"target":"#lrc","url":"/ajax/sf/loans.repayment/${item.id}"}'
                                                class="edit_canvas btn btn-link text-primary fw-semibold text-decoration-none">
                                                Edit
                                            </button>
                                            <button 
                                                type="button"
                                                data-value='{"id":"${item.id}","url":"/ajax/sd/loans.repayment","button":"Delete","title":"Are you sure?","detail":"You are about to permanently delete ${!member_id?`the loan repayment record for <strong>${item.name}</strong>`:"this loan repayment record"}. All associating contents will be deleted and will no longer be accessible."}'
                                                class="prompt_modal btn btn-link text-danger fw-semibold text-decoration-none">
                                                    Delete
                                            </button>
                                        </td>`
                                    : ''
                                }
                                ${table_name == "savings_interest" && table_context == "total" 
                                    ? `${!member_id ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.id}/?tab=savings_interest&sub_tab=${table_context}">${item.name}</a>
                                        </td>`:""}
                                        <td>${item.interest}</td>
                                        <td>${item.date_range}</td>` 
                                    : ''
                                }
                                ${table_name == "savings_interest" && table_context == "all" 
                                    ? `${!member_id ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.mid}/?tab=savings_interest&sub_tab=${table_context}">${item.name}</a>
                                        </td>`:""}
                                        <td>${item.amount}</td>
                                        <td>${item.interest}</td>
                                        <td>${item.total_interest}</td>
                                        <td>${to_local_datetime(item.created_at)}</td>` 
                                    : ''
                                }
                                ${table_name == "savings_interest" && table_context == "each" 
                                    ? `${!member_id ? `<td>
                                            <a href="{% url 'dashboard:members' %}${item.mid}/?tab=savings_interest&sub_tab=${table_context}">${item.name}</a>
                                        </td>`:""}
                                        <td>${item.amount}</td>
                                        <td>${item.interest}</td>
                                        <td>${to_local_datetime(item.created_at)}</td> 
                                        <td>${to_local_datetime(item.updated_at)}</td>` 
                                    : ''
                                }
                            </tr>
                        `
                    }
                    $(`[data-table-name='${table_name}'] .table tbody`).html(table_rows);
                } else $(`[data-table-name='${table_name}'] .table tbody`).html(
                    `<tr class="text-center"><td colspan="${table_head.length + 1}"><p class="fw-semibold text-muted mb-0">No data</p></td></tr>`
                );

                let tab_text = null;
                let filter_count = 0;
                let filter_text = `
                    <svg class="bi" xmlns="http://www.w3.org/2000/svg" viewBox="-2.5 -2.5 24 24" width="32"
                        fill="currentColor">
                        <path
                            d="M8 14A6 6 0 1 0 8 2a6 6 0 0 0 0 12zm6.32-1.094l3.58 3.58a1 1 0 1 1-1.415 1.413l-3.58-3.58a8 8 0 1 1 1.414-1.414z">
                        </path>
                    </svg>
                    Filter
                `;

                const url = new URL(window.location);
                for (let i = 0; i < table_filters[table_name].length; i++) {
                    const item = table_filters[table_name][i];
                    if (url.searchParams.has(item.name)) filter_count += 1;
                }

                let hasQueryParam = window.location.search !== "";
                if (hasQueryParam) {
                    let query = window.location.search.slice(1)
                    let query1 = query.split("&");
                    let query2 = query1.map(item => item.split("="));
                    query2 = Object.fromEntries(query2)
                    tab_text = query2.tab;
                }

                let table_header = `
                    ${hasTabs
                        ? `<div class="btn-group col-12 col-sm-auto mt-2 mt-sm-0 flex-wrap" role="group"
                            aria-label="Table Tabs">
                            ${(table_tab.map((tab, i) => `
                                <input type="radio" class="btn-check" value="${tab[0]}" name='${table_name}_tab' id="tab${i}_${table_name}" autocomplete="off" ${tab_text && tab_text == tab[0] || table_context == tab[0] ? 'checked' : ''} />
                                <label class="btn btn-outline-primary btn-lg rounded-2 border-0 d-inline-flex align-items-center justify-content-center" for="tab${i}_${table_name}">${tab[1]}</label>`)).join("")
                            }
                        </div>`
                        : ""
                    }
                    ${isStaff 
                        ? `<div class="action dropdown ${hasTabs ? "ms-auto" : ""}">
                            <button disabled style="font-size:small" class="btn btn-lg btn-primary rounded-2 dropdown-toggle hstack gap-1"
                                type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                                <svg class="bi" xmlns="http://www.w3.org/2000/svg" viewBox="-9 -2 24 24" width="32"
                                    fill="currentColor">
                                    <path
                                        d="M3 6a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 14a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z">
                                    </path>
                                </svg>
                                Actions
                            </button>
                            <ul class="dropdown-menu border-0 shadow-sm">
                                <li>
                                    <button data-action="export" class="dropdown-item hstack gap-2" type="button"
                                        data-value='{"id":"*","url":"/ajax/se/${table_name}${table_context ?  `.${table_context}`: ""}"}'>
                                        <svg class="bi" xmlns="http://www.w3.org/2000/svg" viewBox="-5 -5 24 24" width="24"
                                            fill="currentColor">
                                            <path
                                                d="M8 3.414v5.642a1 1 0 1 1-2 0V3.414L4.879 4.536A1 1 0 0 1 3.464 3.12L6.293.293a.997.997 0 0 1 1.414 0l2.829 2.828A1 1 0 1 1 9.12 4.536L8 3.414zM3 6a1 1 0 1 1 0 2H2v4h10V8h-1a1 1 0 0 1 0-2h1a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h1z">
                                            </path>
                                        </svg>
                                        Export all records
                                    </button>
                                </li>
                                <li>
                                    <button data-action="export" class="dropdown-item hstack gap-2" type="button"
                                        data-value='{"id":"","url":"/ajax/se/${table_name}${table_context ?  `.${table_context}`: ""}"}'>
                                        <svg class="bi" xmlns="http://www.w3.org/2000/svg" viewBox="-5 -5 24 24" width="24"
                                            fill="currentColor">
                                            <path
                                                d="M8 3.414v5.642a1 1 0 1 1-2 0V3.414L4.879 4.536A1 1 0 0 1 3.464 3.12L6.293.293a.997.997 0 0 1 1.414 0l2.829 2.828A1 1 0 1 1 9.12 4.536L8 3.414zM3 6a1 1 0 1 1 0 2H2v4h10V8h-1a1 1 0 0 1 0-2h1a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h1z">
                                            </path>
                                        </svg>
                                        Export selected
                                    </button>
                                </li>
                                ${!["eoy","savings_interest"].includes(table_name)
                                    ? `<li>
                                        <button data-action="delete" type="button" class="prompt_modal dropdown-item hstack gap-2"
                                            data-value='{"id":"","url":"/ajax/sd/${table_name}${table_context ?  `.${table_context}`: ""}","button":"Delete","title":"Are you sure?","detail":"You are about to permanently delete multiple record(s). All associating contents will be deleted and will no longer be accessible."}'
                                            style="--bs-dropdown-link-active-bg:var(--bs-danger);--bs-dropdown-link-active-color:var(--bs-white);--bs-dropdown-link-color:var(--bs-danger);--bs-dropdown-link-hover-color:var(--bs-danger);">
                                            <svg class="bi" xmlns="http://www.w3.org/2000/svg" viewBox="-3 -2 24 24" width="24"
                                                fill="currentColor">
                                                <path
                                                    d="M6 2V1a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v1h4a2 2 0 0 1 2 2v1a2 2 0 0 1-2 2h-.133l-.68 10.2a3 3 0 0 1-2.993 2.8H5.826a3 3 0 0 1-2.993-2.796L2.137 7H2a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h4zm10 2H2v1h14V4zM4.141 7l.687 10.068a1 1 0 0 0 .998.932h6.368a1 1 0 0 0 .998-.934L13.862 7h-9.72zM7 8a1 1 0 0 1 1 1v7a1 1 0 0 1-2 0V9a1 1 0 0 1 1-1zm4 0a1 1 0 0 1 1 1v7a1 1 0 0 1-2 0V9a1 1 0 0 1 1-1z">
                                                </path>
                                            </svg>
                                            Delete
                                        </button>
                                    </li>`
                                    : ''
                                }
                            </ul>
                        </div>`
                        : ''
                    }
                    <div class="search dropdown">
                        <button type="button" style="font-size:small" 
                            class="btn btn-lg btn-outline-light rounded-2 hstack gap-2 ${!filter_count ? " bg-white text-dark border" : " text-bg-dark"}">
                            ${filter_count ? `<span>Filter Applied: </span><span>${filter_count}</span>` : filter_text}
                        </button>
                        <span class="dropdown-toggle" data-bs-toggle="dropdown" data-bs-auto-close="false" aria-expanded="false"></span>
                        <div style="min-width: 17.5rem;" class="dropdown-menu border-0 shadow py-3 px-2">
                            <form class="vstack gap-2">
                                <div id="filter_fields" class="vstack gap-2">
                                    ${Object.entries(table_filters).map(filter => {
                                        let fields = "";
                                        if (table_name == filter[0]) 
                                            fields = filter[1].map(item => {
                                                let date_range = (kwargs[item.name] || "").split(",");
                                                date_range = date_range[0] !== "" ? [moment(date_range[0], "YYYY-MM-DD").format('Do MMM YYYY'),
                                                    moment(date_range[1], "YYYY-MM-DD").format('Do MMM YYYY')].join(" - ") : "";

                                                return (`
                                                    <div>
                                                        <label for="${item.name}_filter" class="col-form-label p-0">${item.label}</label>
                                                        ${item.type == "text"
                                                            ? `<input type="text" class="form-control rounded-2 small" value="${kwargs[item.name] || ""}" name="${item.name}" id="${item.name}_filter" placeholder="Search..." aria-label="${item.label}" />`
                                                            : item.type == "date"
                                                                ? `<input readonly type="text" value="${date_range}" name="${item.name}" class="form-control daterange small" id="${item.name}_filter" placeholder="Start Date - End Date" aria-label="${item.label}" />`
                                                                : item.type == "select"
                                                                    ? `<select name="${item.name}" data-class="small" id="${item.name}_filter" class="search-select" data-menu-class="w-auto" aria-label="Show per page">
                                                                            ${item.options.map((option, i) => `<option value="${option[0]}" ${`${option[0]}` === (kwargs[item.name] || "null") ? "selected": ""}>${option[1]}</option>`).join("")}
                                                                        </select>`
                                                                    :""
                                                        }
                                                    </div>
                                            `)}).join("");
                                        
                                        return fields
                                    }).join("")}
                                </div>
                                <div class="hstack gap-2 align-items-center justify-content-end">
                                    <button type="button" id="clear_search"
                                        class="fw-midbold btn btn-sm btn-light bg-white hstack gap-1 align-items-center"
                                        style="font-size: small;">
                                        <svg class="bi" xmlns="http://www.w3.org/2000/svg" viewBox="-6 -6 24 24" width="32"
                                            fill="currentColor">
                                            <path
                                                d="M7.314 5.9l3.535-3.536A1 1 0 1 0 9.435.95L5.899 4.485 2.364.95A1 1 0 1 0 .95 2.364l3.535 3.535L.95 9.435a1 1 0 1 0 1.414 1.414l3.535-3.535 3.536 3.535a1 1 0 1 0 1.414-1.414L7.314 5.899z">
                                            </path>
                                        </svg>
                                        Reset
                                    </button>
                                    <button type="submit"
                                        class="fw-midbold btn btn-sm btn-primary hstack gap-1 align-items-center"
                                        style="font-size: small;">
                                        <svg class="bi" xmlns="http://www.w3.org/2000/svg" viewBox="-2.5 -2.5 24 24" width="32"
                                            fill="currentColor">
                                            <path
                                                d="M8 14A6 6 0 1 0 8 2a6 6 0 0 0 0 12zm6.32-1.094l3.58 3.58a1 1 0 1 1-1.415 1.413l-3.58-3.58a8 8 0 1 1 1.414-1.414z">
                                            </path>
                                        </svg>
                                        Filter
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;


                let pagination = `
                    <li class="page-item">
                        <button 
                            id="prev"
                            type="button" 
                            aria-label="Previous"  
                            data-page="${data.attr.prev ?? ""}"
                            ${!data.attr.prev ? "disabled" : ""}
                            class="border rounded-1 btn btn-light fw-semibold">
                            <span aria-hidden="true">&laquo;</span>
                        </button>
                    </li>
                    <li class="page-item hstack gap-2">
                        <input 
                            step="1" 
                            type="number" 
                            placeholder="1" 
                            max="${data.attr.pages}" 
                            aria-label="Page number" 
                            value="${data.attr.current}" 
                            name="pagination-page-number"
                            ${!(data.attr.next || data.attr.prev) ? 'disabled' : ''} 
                            class="form-control text-center h-100 rounded-1 px-2 py-1" style="width: 2rem;">
                        / 
                        <span>${data.attr.pages}</span>
                    </li>
                    <li class="page-item">
                        <button 
                            id="next"
                            type="button" 
                            aria-label="Previous"
                            data-page="${data.attr.next ?? ''}"
                            ${!data.attr.next ? 'disabled' : ''}
                            class="border rounded-1 btn btn-light fw-semibold">
                            <span aria-hidden="true">&raquo;</span>
                        </button>
                    </li>
                `;

                let table_foot = `
                    <div>
                        <div class="hstack gap-2">
                            <label for="per_page" class="lh-1">Per Page:</label>
                            <select id="per_page" class="search-select" data-menu-class="w-auto" aria-label="Show per page">
                                <option ${data.attr.per_page == 5 ? "selected" : ""} value="5">5</option>
                                <option ${data.attr.per_page == 10 ? "selected" : ""} value="10">10</option>
                                <option ${data.attr.per_page == 20 ? "selected" : ""} value="20">20</option>
                                <option ${data.attr.per_page == 50 ? "selected" : ""} value="50">50</option>
                                <option ${data.attr.per_page == 100 ? "selected" : ""} value="100">100</option>
                                <option ${data.attr.per_page == 200 ? "selected" : ""} value="200">200</option>
                                <option ${data.attr.per_page == 500 ? "selected" : ""} value="500">500</option>
                            </select>
                        </div>
                    </div>
                    <div id="pagination">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination mb-0 hstack gap-2">
                                ${pagination}
                            </ul>
                        </nav>
                    </div>
                `;

                if (data.attr.extra && data.content.length != 0 && table_name ==
                    "savings_interest" && table_context == "total") {
                    $("#tid").removeClass("d-none");
                    $("#tin").html(data.attr.extra.total_interest);
                }
                if (table_name == "savings_interest" && !data.attr.extra && data.content.length == 0 &&
                    table_context != "total") {
                    $("#tid").addClass("d-none");
                    $("#tin").html("N/A");
                }

                $(`[data-table-name='${table_name}'] .table .tableChkMaster`).prop({
                    disabled: data.content.length == 0
                });
                $(`[data-table-name='${table_name}'] .txn-head`).html(table_header);
                $(`[data-table-name='${table_name}'] .txn-foot`).html(table_foot);
                create_custom_dropdowns();
                setCalenders();

                const myDropdown = $(`[data-table-name='${table_name}'] .search>button`);
                myDropdown.on("click", function () {
                    bootstrap.Dropdown
                        .getOrCreateInstance($(this).next(".dropdown-toggle"))
                        .toggle();
                });
            }
        });
    }

    const fetchNotifications = count => $.ajax({
        type: 'GET',
        dataType: 'json',
        url: `{% url 'ajax:notify.list' %}?count=${count}`,
        beforeSend: xhr => {
            let btn = $("#notification_btn>button#loadBtn");
            btn.prop("disabled", true);
            btn.html(`
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                Loading...
            `);
        },
        success: data => {
            let messages = "";
            if (data.list.length > 0) {
                messages = data.list.map((item, i) => {
                    return `
                        <li 
                            data-id="${item.id}"
                            aria-expanded="false"
                            aria-controls="nc${i}"
                            style="cursor:pointer"
                            data-bs-target="#nc${i}"
                            data-bs-toggle="collapse"   
                            class="list-group-item border-0 border-bottom list-group-item-action ${item.unread?'bg-light fw-bold':''}">
                            <div style="display:grid;grid-template-columns:min-content 1fr;gap:.5rem">
                                <span class="bg-${item.level != "error" ? item.level : 'danger'} rounded-circle d-flex align-items-center justify-content-center bg-opacity-25 text-${item.level != "error" ? item.level : 'danger'}" style="height:1.5rem;width:1.5rem;">
                                    <svg style="width:1rem;height:1rem;fill:currentColor;">
                                        <use xlink:href="{% static 'svg/sprite.svg' %}#icon-${item.level}-bold"></use>
                                    </svg>
                                </span>
                                <div class="d-flex w-100 justify-content-between">
                                    <div>
                                        <h6 class="lh-1 mb-0 ${item.unread?'fw-bold':''}">${item.verb}</h6>
                                        <small class="text-muted">${relative_time(item.timestamp)}</small>
                                    </div>
                                    <button data-id="${item.id}" style="width:3px;height:3px" type="button" class="btn-close mb-auto ms-auto"></button>
                                </div>
                            </div>
                            <div class="collapse" id="nc${i}">
                                <small>${item.description}</small>
                            </div>
                        </li>
                    `;
                }).join('');
                $('#notification_btn').removeClass("d-none");
                let btn = $("#notification_btn>button#loadBtn");
                btn.attr("data-value", count);
                btn.prop("disabled", false);
                btn.html(`Load More`);
            } else {
                messages += `
                    <li 
                        style="cursor:pointer"
                        class="list-group-item border-0 list-group-item-action">
                        <div class="hstack gap-2">
                            <div class="d-flex align-items-center justify-content-center">
                                <span class="bg-secondary bg-opacity-25 text-muted rounded-circle d-flex align-items-center justify-content-center" style="height:1.5rem;width:1.5rem;">
                                    <svg style="width:1rem;height:1rem;fill:currentColor;">
                                        <use xlink:href="{% static 'svg/sprite.svg' %}#icon-error-bold"></use>
                                    </svg>
                                </span>
                            </div>
                            <div class="d-flex w-100 justify-content-between">
                                <div>
                                    <h6 class="lh-1 mb-1">No Notification</h6>
                                    <small class="text-muted">-</small>
                                </div>
                            </div>
                        </div>
                    </li>
                `;
                $('#notification_btn').addClass("d-none");
            }
            $("#notifications").html(messages);
            if (data.count == $("#notifications>li").length)
                $('#notification_btn>button#loadBtn').prop("disabled", true);
        }
    });

    $('#notify').on("show.bs.dropdown", () => fetchNotifications(5));
    $('#notification_btn>button#loadBtn').on("click", function () {
        let count = parseInt($(this).attr("data-value"));
        fetchNotifications(count += 5);
    })

    $(document).on('click', '#notifications>li', function (e) {
        var self = $(this);
        $.ajax({
            type: 'GET',
            dataType: 'json',
            url: "{% url 'ajax:notify.mark_read' %}",
            data: {
                id: self.attr('data-id')
            },
            success: () => self.removeClass('bg-light fw-bold'),
        })

    })

    $(document).on("click", "#notifications .btn-close", function (e) {
        e.stopPropagation();
        var self = $(this);
        $.ajax({
            type: 'GET',
            data: {
                id: self.attr('data-id')
            },
            dataType: 'json',
            url: `{% url 'ajax:notify.delete' %}`,
            success: data => {
                if (data.is_deleted) $(self.parents()[2]).remove();
            }
        });
    })

    $(document).on("click", "#notifications-main .btn-close-main", () => bootstrap.Dropdown
        .getInstance($(".not-drpdwn")).hide());

    const performLoanFetch = (context, offcanvas, value) => {
        if (value != "") $.ajax({
            type: "GET",
            url: `/ajax/gld/${value}`,
            error: ({
                responseJSON: res
            }) => toast(res.status, res.message),
            success: res => {
                offcanvas.find("#id_loan").val(res.data.loan);
                if (context == "change") offcanvas.find("#id_loan").prop("disabled", false);
                offcanvas.find("#outAmt1").val(res.data.outstanding);
                offcanvas.find("#outAmt2").val(res.data.outstanding);
                create_custom_dropdowns();
            }
        });
        else {
            offcanvas.find("#id_loan").val("");
            offcanvas.find("#id_amount").val("");
            offcanvas.find("#outAmt1").val("-");
            offcanvas.find("#outAmt2").val("-");
            offcanvas.find("#id_loan").prop("disabled", true);
            create_custom_dropdowns();
        }
    }

    $(".offcanvas#lrc #id_member").on("change", function () {
        let value = $(this).val();
        let offcanvas = $(this).closest(".offcanvas");
        performLoanFetch("change", offcanvas, value);
    })
    $(".offcanvas#lrc #id_amount").on("input", function () {
        let value = $(this).val();
        value = value.toString().replace("e", "");
        value = value != "" ? parseFloat(value) : null;
        let data_amt = $("#outAmt1").val();
        let currency = data_amt[0];
        let outstanding_amount = data_amt.slice(1).replaceAll(",", "");
        let outstanding_amount_int = parseFloat(outstanding_amount);
        if (value > outstanding_amount_int) {
            value = outstanding_amount_int;
            $(this).val(value);
        };
        let outstanding_amount_str =
            `${currency}${(outstanding_amount_int - value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        $("#outAmt2").val(outstanding_amount_str);

    })
    $(".offcanvas#lrc").on("shown.bs.offcanvas", function () {
        let offcanvas = $(this);
        let value = offcanvas.find("#id_member").val();
        performLoanFetch("show", offcanvas, value);
    })

    var formSubmit = {
        ValidateSubmit: ({
            context,
            btnData,
            url,
            formData
        }) => {
            // send request to handler
            return $.ajax({
                url: url,
                type: "POST",
                cache: false,
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: xhr => {
                    $(".is-invalid").removeClass("is-invalid");
                    $(".invalid-feedback").removeClass("d-block");
                    $(".invalid-feedback").html();
                },
                success: res => { // <----- make sure you use .then
                    toast(res.status, res.message);
                    setTable();
                    if (["shares", "savings.debit", "savings.credit"].includes(context))
                        $(`.total[data-context='${context.split(".")[0]}']`).html(
                            res.data.total);

                    const DISPLAY = $('.offcanvas.show, .modal.show');
                    let form = DISPLAY.find("form");
                    form[0].reset();
                    DISPLAY.removeClass("show");
                    $(".offcanvas-backdrop, .modal-backdrop").removeClass("show");
                    btnData[0].html(btnData[1]);
                    btnData[0].prop("disabled", false);
                },
                error: ({
                    responseJSON: res
                }) => {
                    if (res.message) toast(res.status, res.message);
                    else Object.entries(res.data).forEach(field => {
                        let _name = field[0];
                        let _error = field[1];
                        let target = $(`#id_${_name}`);
                        target.addClass("is-invalid");
                        if (target.parent().hasClass("form-floating")) {
                            target.parent().parent().find(".invalid-feedback").html(
                                _error);
                            target.parent().parent().find(".invalid-feedback").addClass(
                                "d-block");
                        } else {
                            target.next(".invalid-feedback").html(_error);
                            target.next(".invalid-feedback").addClass("d-block");
                        }
                    });
                    create_custom_dropdowns();

                    btnData[0].html(btnData[1]);
                    btnData[0].prop("disabled", false);
                }
            })
        }
    }

    $(document).on("submit", ".offcanvas form", function (e) {
        e.preventDefault();
        let form = $(this);
        let formData = new FormData();
        let name = form.attr("data-name");
        let context = form.attr("data-context");
        let id = form.find("input[name='id']").val();
        let btn = form.find("button[type='submit']");
        let btnText = btn.html();

        let contexts = {
            lc: "loans",
            sc: "shares",
            swc: "savings.debit",
            sdc: "savings.credit",
            lrc: "loans.repayment",
        }
        let url = context == "create" ? `/ajax/sc/${contexts[name]}` : `/ajax/su/${contexts[name]}/${id}`;


        form.find(
            `input:not(
                .date,
                .datetime,
                .dd-searchbox,
                [type='file'],
                [type='radio'],
                [type='checkbox']
            ), 
            textarea`
        ).each(function () {
            if (
                ($(this).is(":disabled") && $(this).hasAttr("readonly")) ||
                (!$(this).is(":disabled") && !$(this).hasAttr("readonly"))
            )
                formData.append($(this).attr("name"), $(this).val());
        });

        let select = form.find("select");
        if (select.length) select.each(function () {
            let self = $(this);
            if (
                (self.is(":disabled") && self.hasAttr("readonly")) ||
                (!self.is(":disabled") && !self.hasAttr("readonly"))
            ) {
                if (!self.hasAttr("multiple"))
                    formData.append(self.attr("name"), self.val());
                else self.find("option:selected").each(function () {
                    formData.append(self.attr("name"), $(this).val());
                })
            }
        })

        if (member_id) formData.append("isMember", true);

        let image = form.find("input[type='file']");
        if (image.length) formData.append(image.attr("name"), image[0].files[0])

        let check_box = form.find("input[type='checkbox']:not(.dropdown-check)");
        if (check_box.length) check_box.each(function () {
            formData.append($(this).attr("name"), $(this).is(":checked"))
        })

        let radio = form.find("input[type='radio']");
        if (radio.length) radio.each(function () {
            if ($(this).is(":checked")) formData.append($(this).attr("name"), $(this).val());
        })

        let datetimes = form.find("input.datetime");
        if (datetimes.length) datetimes.each(function () {
            formData.append($(this).attr("name"), $(this).val() != '' ? moment($(this).val(),
                'MMM DD, YYYY, hh:mm a').format() : '');
        })

        btn.prop("disabled", true);
        btn.html(`
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            Processing...
        `);

        return formSubmit.ValidateSubmit({
            context: name != "cm" ? contexts[name] : "",
            btnData: [btn, btnText],
            url,
            formData
        });

    });
    $(document).on("click", ".prompt_modal", function () {
        let modal = $("#promptModal");
        const MODAL = new bootstrap.Modal(modal);
        let data = JSON.parse($(this).attr("data-value"));
        modal.find(".btn[type='submit']").html(data.button);
        modal.find("#body").html(`
            <h3 class="text-center">${data.title}</h3>
            <p class="mb-0 text-center">${data.detail}</p>
        `);
        modal.find("form").attr("action", data.url);
        modal.find("form input[name='id']").attr("value", data.id);
        MODAL.show();
    });
    $(document).on("submit", ".modal#promptModal form", function (e) {
        e.preventDefault();
        let form = $(this);
        let formData = new FormData();
        let btn = form.find("button[type='submit']");
        let btnText = btn.html();
        let url = form.attr("action");

        form.find(`input`)
            .each(function () {
                if ($(this).attr("name") == "id") {
                    let IDs = $(this).val().split(",");
                    for (let i = 0; i < IDs.length; i++)
                        formData.append($(this).attr("name"), IDs[i]);
                } else formData.append($(this).attr("name"), $(this).val());
            });


        btn.prop("disabled", true);
        btn.html(`
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
            Processing...
        `);

        return formSubmit.ValidateSubmit({
            btnData: [btn, btnText],
            url,
            formData
        });

    });

    $(document).on("click", ".edit_canvas", function () {
        let data = JSON.parse($(this).attr("data-value"));
        let canvas = $(`.offcanvas${data.target}`);
        const CANVAS = new bootstrap.Offcanvas(canvas);

        $.ajax({
            method: 'GET',
            url: data.url,
            success: function (res) {
                canvas.find("form").attr("data-context", "edit");
                canvas.find("form").find("input[name='id']").val(data.url.split("/").slice(-1)[0]);
                Object.entries(res.data).forEach(field => {
                    let key = field[0];
                    let value = field[1];
                    let target = canvas.find("form").find(`#id_${key}`);
                    if (!Array.isArray(value)) target.val(value);
                    else {
                        value.forEach(item => {
                            target.find(`option[value='${item}']`).prop(
                                "selected", true);
                        });
                    }
                });
                CANVAS.show();
                create_custom_dropdowns();
                resetDateTime();
                resetDate();
            }
        });
    });

    // TABLE
    // TABLE HEADER
    const check = table => {
        let table_name = table.dataset["tableName"];
        let table_attr = JSON.parse(table.dataset["tableAttr"]);

        let list = [...(table_attr.selected_id || [])];

        let masterCheck = table.querySelector("th>input[type='checkbox']");
        let childCheck = table.querySelectorAll("td>input[type='checkbox']");
        childCheck.forEach(child => {
            let id = parseInt(child.value);
            let index = list.indexOf(id);
            let checked = child.checked;
            if (checked && index < 0) list.push(id);
            if (!checked && index >= 0) list.splice(index, 1);
        });

        let arrLen = list.length;
        masterCheck.indeterminate = arrLen > 0 && arrLen !== childCheck.length;
        if (arrLen == childCheck.length) masterCheck.checked = true;
        if (arrLen == 0) masterCheck.checked = false;
        table.querySelector(".action>button").disabled = !(arrLen > 0);

        table_attr.selected_id = list;
        let table_attr_stringify = JSON.stringify(table_attr);
        table.dataset["tableAttr"] = table_attr_stringify;
        table.querySelectorAll(".action ul>li:not(:first-child) button").forEach(btn => {
            let data = JSON.parse(btn.dataset.value);
            data.id = table_attr.selected_id.join(",");
            btn.dataset.value = JSON.stringify(data);
        })
    };
    $(document).on('change', '#sort_by', function () {
        let table = $(this).closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        let table_attr = JSON.parse(table.attr("data-table-attr"));
        table_attr.sort_by = $(this).val();
        tabulate(table_name, table_attr);
    })
    $(document).on('click', '.txn-head .btn-group label', function () {
        let value = $(this).prev().val();
        let table = $(this).closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        let table_attr = JSON.parse(table.attr("data-table-attr"));
        table_attr.table_context = value;

        if (table_name == "savings_interest") {
            if (value == "total") $("#tid").removeClass("d-none");
            else $("#tid").addClass("d-none");
        }

        tabulate(table_name, table_attr);

        const url = new URL(window.location);
        url.searchParams.set("tab", value);
        if (member_id) {
            url.searchParams.set("tab", table_name);
            url.searchParams.set("sub_tab", value);
        }
        window.history.pushState(null, null, url);
    })
    // EXPORT
    $(document).on("click", "button[data-action='export']", function () {
        let table = $(this).closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        let table_attr = JSON.parse(table.attr("data-table-attr"));
        let data = JSON.parse($(this).attr("data-value"));
        $.ajax({
            method: 'GET',
            url: data.url,
            traditional: true,
            xhrFields: {
                responseType: 'blob'
            },
            data: {
                id: data.id.split(","),
                ...(member_id ? {
                    member_id: member_id
                } : {}),
                ...(table_attr.search_date ? {
                    range: table_attr.search_date
                } : {})
            },
            beforeSend: xhr => {
                toast("info", "File export download starting...")
            },
            success: function (data) {
                toast("success", "File export downloading. Please wait...")
                var a = document.createElement('a');
                var url = window.URL.createObjectURL(data);
                a.href = url;
                a.download =
                    `export_${'{{dashboard.title}}'.toLowerCase().replaceAll(" ", "_")}.pdf`;
                document.body.append(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            }
        });
    });
    $(document).on("submit", ".search form", function (e) {
        e.preventDefault();
        let table = $(this).closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        var table_attr = JSON.parse(table.attr("data-table-attr"));
        $(this).find("select, input:not([type='hidden'])").each(function () {
            let field = $(this);
            if (!field.hasClass("daterange"))
                table_attr[field.attr("name")] = field.val() && field.val() !== "null" ?
                field.val() : "";
            else {
                let values = field.val().split("-");
                if (values.length == 2)
                    table_attr[field.attr("name")] = [moment(values[0], 'Do MMM YYYY').format(
                            "YYYY-MM-DD"),
                        moment(values[1], 'Do MMM YYYY').format("YYYY-MM-DD")
                    ].join(",");
            }
        });
        tabulate(table_name, table_attr);

        const url = new URL(window.location);
        for (let i = 0; i < table_filters[table_name].length; i++) {
            const item = table_filters[table_name][i];
            if (
                table_attr.hasOwnProperty(item.name) &&
                (table_attr[item.name] != "" &&
                    table_attr[item.name] != "null" &&
                    table_attr[item.name] != null)
            ) url.searchParams.set(item.name, table_attr[item.name]);
        }
        window.history.pushState(null, null, url);
    });
    $(document).on("click", ".search #clear_search", function () {
        let form = $(this).closest("form");
        let table = form.closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        let table_attr = JSON.parse(table.attr("data-table-attr"));
        form.find("select, input:not([type='hidden'])").each(function () {
            table_attr[$(this).attr("name")] = null;
        });
        form[0].reset();

        tabulate(table_name, table_attr);
        const url = new URL(window.location);
        for (let i = 0; i < table_filters[table_name].length; i++) {
            const item = table_filters[table_name][i];
            if (url.searchParams.has(item.name)) url.searchParams.delete(item.name);
        }
        window.history.pushState(null, null, url);
    });
    $(document).on("change", ".tableChkMaster", function () {
        let self = $(this);
        let isChecked = self.is(":checked");
        let table = $(this).closest("[data-table-name]");
        table.find("td>input[type='checkbox']").each(function () {
            $(this).prop("checked", isChecked)
        });
        check(table[0]);
    });
    $(document).on("change", "td>input[type='checkbox']", function () {
        check($(this).closest("[data-table-name]")[0]);
    });

    // TABLE FOOT
    $(document).on('click', '.pagination #prev, .pagination #next', function () {
        let table = $(this).closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        let table_attr = JSON.parse(table.attr("data-table-attr"));
        table_attr.page = $(this).attr('data-page');
        tabulate(table_name, table_attr);
    });
    $(document).on('input', '.pagination input', function () {
        let page = null;
        let value = $(this).val().trim();
        let table = $(this).closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        let table_attr = JSON.parse(table.attr("data-table-attr"));

        if (value !== "") page = value;
        if (parseInt(value) == 0) page = 1;
        if (page) {
            table_attr.page = page;
            tabulate(table_name, table_attr);
        }
    });
    $(document).on('change', '.txn-foot select', function () {
        let table = $(this).closest("[data-table-name]");
        let table_name = table.attr("data-table-name");
        let table_attr = JSON.parse(table.attr("data-table-attr"));
        table_attr.per_page = $(this).val();
        tabulate(table_name, table_attr);
    });
</script>
{% block dashboard_script %}{% endblock  %}
{% endblock  %}